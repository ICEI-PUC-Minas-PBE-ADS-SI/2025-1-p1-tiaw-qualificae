<!DOCTYPE html>
<html lang="pt-br">

<head>


  <!--
Relatorio de problemas:[
Victor: (31/05): O json não esta sendo reconhecido de forma correta, ao efetuar o login a mensagem de erro de servidor aparece 

]


  Página de Login e Cadastro de Usuário

  Esta página contém um sistema simples para autenticação e registro de usuários,
  dividido em duas partes principais: formulário de login e formulário de cadastro.

  1. Estrutura e Estilos:
     - Metatags para responsividade e charset UTF-8.
     - Inclusão de ícones e componentes do Bootstrap.
     - Estilos CSS externos e internos para layout e mensagens.

  2. Formulários:
     - Login: solicita e-mail/usuário e senha para autenticação.
     - Cadastro: permite criar um novo usuário com dados como nome, data de nascimento, telefone, e-mail, cidade, LinkedIn, senha e confirmação de senha.
     - O formulário de cadastro está inicialmente oculto e é exibido ao clicar no botão "Cadastrar".

  3. Funcionalidades JavaScript:
     - Exibe mensagens de sucesso ou erro com animação.
     - Valida o login consultando uma API REST para verificar usuário e senha.
     - Valida o cadastro com checagem de dados obrigatórios, senha, idade mínima (18 anos) e duplicidade de e-mail via API.
     - Alterna entre formulários de login e cadastro dinamicamente.
     - Aplica máscara de telefone no campo correspondente.
     - Configura foco automático nos campos apropriados ao carregar a página ou alternar formulários.

  4. Integração Backend:
     - Usa chamadas fetch para comunicação com uma API REST local (endereço configurado na variável API_URL).
     - No login, busca usuário pelo e-mail e compara senha.
     - No cadastro, verifica se o e-mail já existe e registra o novo usuário via POST.

  5. Recursos adicionais:
     - Inclusão de scripts externos para funcionalidades extras.
     - Ícones visuais para melhor usabilidade nos inputs.

  Estrutura de codigo 

1. Configurações e Estilos
   ├─ Meta tags
   ├─ Inclusão de bibliotecas
   └─ Estilos CSS

2. Estrutura HTML
   ├─ Formulário de Login (padrão)
   └─ Formulário de Cadastro (oculto)

3. Funções JavaScript
   ├─ Gerenciamento de Mensagens
   ├─ Validação de Login
   ├─ Cadastro de Usuário
   ├─ Alternância de Formulários
   └─ Utilitários (máscara, foco)

4. Recursos Externos
   └─ Scripts adicionais
  -->


  <!-- =============================================
      1. CONFIGURAÇÕES E ESTILOS
      ============================================= -->

  <!-- 1.1 Meta Tags -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Desenvolvimento de Interfaces Web | Login de Usuário</title>

  <!-- 1.2 Inclusão de Bibliotecas -->
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>

  <!-- 1.3 Estilos CSS -->
  <!-- Arquivo CSS externo -->
  <link rel="stylesheet" href="assets/css/stylelogin.css">

  <!-- Estilos internos para mensagens -->
  <style>
    /* Animações para mensagens */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }

      to {
        opacity: 0;
      }
    }

    /* Estilo base para mensagens */
    #message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 25px;
      border-radius: 5px;
      z-index: 1000;
      color: white;
      background-color: #2ecc71;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      animation: fadeIn 0.3s ease-in-out;
    }

    /* Variante para mensagens de erro */
    #message.error {
      background-color: #e74c3c;
    }
  </style>
</head>

<body class="PainelDeLogin">
  <!-- =============================================
      2. ESTRUTURA HTML
      ============================================= -->
  <div id="login">
    <div class="container">
      <div id="login-row" class="row justify-content-center align-items-center bg-secondary m-5 p-5">
        <div id="login-column" class="col-md-6">

          <!-- 2.1 Formulário de Login (padrão) -->
          <div id="login-box" class="col-md-12 login-form-container">
            <form id="login-form" class="form" method="post" onsubmit="validarLogin(event)">
              <div class="form-group">
                <!-- Logo -->
                <div class="logo-container">
                  <img src="assets/images/logo-azul.png" alt="Logo do sistema" class="login-logo">
                </div>

                <!-- Campo Usuário -->
                <div class="form-group input-icon-container">
                  <i class="bi bi-person-fill icon-inside"></i>
                  <input type="text" name="username" id="username" class="form-control with-icon" placeholder="Login"
                    required>
                </div>

                <!-- Campo Senha -->
                <div class="form-group input-icon-container">
                  <i class="bi bi-lock-fill icon-inside"></i>
                  <input type="password" name="password" id="password" class="form-control with-icon"
                    placeholder="Senha" required>
                </div>

                <!-- Botões -->
                <div class="form-group botoes-login">
                  <input type="submit" name="submit" class="btn btn-login text-light" value="Entrar">
                  <div class="divisoria-ou">OU</div>
                  <button type="button" class="btn btn-registrar text-light"
                    onclick="mostrarFormularioCadastro()">Cadastrar</button>
                </div>
              </div>
            </form>
          </div>

          <!-- 2.2 Formulário de Cadastro (oculto) -->
          <div id="register-box" class="col-md-12 register-form-container" style="display: none;">
            <form id="register-form" class="form" method="post" onsubmit="cadastrarUsuario(event)">
              <div class="form-group">
                <!-- Logo -->
                <div class="logo-container">
                  <img src="assets/images/logo-azul.png" alt="Logo do sistema" class="login-logo">
                </div>

                <h3>Cadastro</h3>

                <!-- Campos do formulário -->
                <div class="form-group input-icon-container">
                  <i class="bi bi-person-fill icon-inside"></i>
                  <input type="text" name="nome_completo" id="nome_completo" class="form-control with-icon"
                    placeholder="Nome Completo" required>
                </div>

                <div class="form-group input-icon-container">
                  <i class="bi bi-calendar-date icon-inside"></i>
                  <input type="date" name="data_nascimento" id="data_nascimento" class="form-control with-icon"
                    required>
                </div>

                <div class="form-group input-icon-container">
                  <i class="bi bi-telephone-fill icon-inside"></i>
                  <input type="tel" name="telefone" id="telefone" class="form-control with-icon"
                    placeholder="(00) 00000-0000" pattern="\(\d{2}\) \d{4,6}-\d{3,4}" required>
                </div>

                <div class="form-group input-icon-container">
                  <i class="bi bi-envelope-fill icon-inside"></i>
                  <input type="email" name="email" id="email" class="form-control with-icon" placeholder="E-mail"
                    required>
                </div>

                <div class="form-group input-icon-container">
                  <i class="bi bi-geo-alt-fill icon-inside"></i>
                  <input type="text" name="cidade" id="cidade" class="form-control with-icon" placeholder="Cidade"
                    required>
                </div>

                <div class="form-group input-icon-container">
                  <i class="bi bi-linkedin icon-inside"></i>
                  <input type="url" name="linkedin" id="linkedin" class="form-control with-icon"
                    placeholder="https://linkedin.com/in/seu-perfil" pattern="https://linkedin.com/in/.*">
                </div>

                <div class="form-group input-icon-container">
                  <i class="bi bi-lock-fill icon-inside"></i>
                  <input type="password" name="senha" id="senha" class="form-control with-icon" placeholder="Senha"
                    minlength="6" required>
                </div>

                <div class="form-group input-icon-container">
                  <i class="bi bi-lock-fill icon-inside"></i>
                  <input type="password" name="confirmar_senha" id="confirmar_senha" class="form-control with-icon"
                    placeholder="Confirme sua senha" minlength="6" required>
                </div>

                <!-- Botões -->
                <div class="form-group botoes-login">
                  <button type="submit" id="btn_cadastrar" class="btn btn-info">Finalizar Cadastro</button>
                  <button type="button" class="btn btn-secondary" onclick="voltarParaLogin()">Cancelar</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- =============================================
      3. FUNÇÕES JAVASCRIPT
      ============================================= -->
  <script>
    //alterei a porta de onde vai abrir -manu
    // Configuração global
    const API_URL = 'http://localhost:3000/usuarios';

    /* 3.1 Gerenciamento de Mensagens
    ---------------------------------------- */
    function displayMessage(msg, isError = false) {
      const oldMessage = document.getElementById('message');
      if (oldMessage) oldMessage.remove();

      const messageDiv = document.createElement('div');
      messageDiv.id = 'message';
      messageDiv.textContent = msg;
      if (isError) messageDiv.classList.add('error');

      document.body.appendChild(messageDiv);

      setTimeout(() => {
        messageDiv.style.animation = 'fadeOut 0.3s ease-in-out';
        setTimeout(() => messageDiv.remove(), 300);
      }, 5000);
    }

    /*---------------------------------------- 
 /* 3.2 Validação de Login
 ---------------------------------------- */
    async function validarLogin(event) {
      event.preventDefault();

      const email = document.getElementById('username').value.trim().toLowerCase();
      const senha = document.getElementById('password').value;

      try {
        const response = await fetch(`${API_URL}?email=${encodeURIComponent(email)}`);
        const usuarios = await response.json();

        const usuario = usuarios.find(u => u.email.toLowerCase() === email);

        if (!usuario) {
          displayMessage('Usuário não encontrado!', true);
          return;
        }

        if (usuario.senha === senha) {
          sessionStorage.setItem('usuarioCorrente', JSON.stringify(usuario));
          displayMessage('Login realizado! Redirecionando...');
          setTimeout(() => window.location.href = "usuario.html", 1000);
        } else {
          displayMessage('Senha incorreta!', true);
        }
      } catch (error) {
        displayMessage('Erro ao conectar com o servidor', true);
        console.error("Erro no login:", error);
      }
    }

    /* 3.3 Cadastro de Usuário
    ---------------------------------------- */
    async function cadastrarUsuario(event) {
      event.preventDefault();

      const novoUsuario = {
        nome_completo: document.getElementById('nome_completo').value,
        email: document.getElementById('email').value,
        senha: document.getElementById('senha').value,
        telefone: document.getElementById('telefone').value,
        data_nascimento: document.getElementById('data_nascimento').value,
        cidade: document.getElementById('cidade').value,
        linkedin: document.getElementById('linkedin').value || null,
        fotoPerfil: "img/default.jpg",
        experiencia: "",
        habilidades: "",
        formacaoAcademica: "",
        certificacoes: "",
        favoritosIds: []
      };

      const confirmarSenha = document.getElementById('confirmar_senha').value;

      // Validações
      if (!novoUsuario.nome_completo || !novoUsuario.email || !novoUsuario.senha) {
        displayMessage('Preencha todos os campos obrigatórios!', true);
        return;
      }

      if (novoUsuario.senha !== confirmarSenha) {
        displayMessage('As senhas não coincidem!', true);
        return;
      }

      if (novoUsuario.senha.length < 6) {
        displayMessage('A senha deve ter pelo menos 6 caracteres!', true);
        return;
      }

      // Validação de idade
      const nascimento = new Date(novoUsuario.data_nascimento);
      const hoje = new Date();
      let idade = hoje.getFullYear() - nascimento.getFullYear();
      const mes = hoje.getMonth() - nascimento.getMonth();
      if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
        idade--;
      }
      if (idade < 18) {
        displayMessage('Você deve ter pelo menos 18 anos para se cadastrar!', true);
        return;
      }

      try {
        const checkEmail = await fetch(`${API_URL}?email=${encodeURIComponent(novoUsuario.email)}`);
        const existente = await checkEmail.json();

        if (existente.length > 0) {
          displayMessage('Este e-mail já está cadastrado!', true);
          return;
        }

        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(novoUsuario)
        });

        if (response.ok) {
          displayMessage('Cadastro realizado com sucesso! Redirecionando...');
          document.getElementById('username').value = novoUsuario.email;
          setTimeout(() => voltarParaLogin(), 1500);
        } else {
          throw new Error('Falha no cadastro');
        }
      } catch (error) {
        console.error("Erro no cadastro:", error);
        displayMessage("Erro ao cadastrar. Tente novamente mais tarde.", true);
      }
    }

    /* 3.4 Alternância de Formulários
    ---------------------------------------- */
    function mostrarFormularioCadastro() {
      document.getElementById('login-box').style.display = 'none';
      document.getElementById('register-box').style.display = 'block';
      document.getElementById('nome_completo').focus();
    }

    function voltarParaLogin() {
      document.getElementById('register-box').style.display = 'none';
      document.getElementById('login-box').style.display = 'block';
      document.getElementById('username').focus();
    }

    /* 3.5 Utilitários
    ---------------------------------------- */
    // Máscara para telefone
    document.getElementById('telefone')?.addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 2) value = `(${value.substring(0, 2)}) ${value.substring(2)}`;
      if (value.length > 10) value = `${value.substring(0, 10)}-${value.substring(10, 14)}`;
      e.target.value = value;
    });

    // Foco automático
    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('username')?.focus();
    });
  </script>

  <!-- =============================================
      4. RECURSOS EXTERNOS
      ============================================= -->
  <script src="../../assets/js/login.js"></script>
</body>

</html>